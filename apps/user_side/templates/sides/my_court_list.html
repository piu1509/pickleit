{% extends 'base/base_user.html' %}
{% load static %}

{% block style %}
<style>
    .court-image {
        width: 400px;
        height: 250px;
        object-fit: cover;
        border-radius: 10px;
    }
    .deactivated {
        opacity: 0.6;
        pointer-events: none;
        filter: grayscale(80%);
    }
    .disabled-link {
        pointer-events: none;
        color: #999 !important;
        text-decoration: none !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
    <h1 class="h4 mb-0">My Courts</h1>
    <div class="d-flex align-items-center mt-2 mt-md-0">
        {% if error %}
            <a href="#" class="btn btn-info" id="subscribe-btn"
               data-bs-toggle="popover"
               data-bs-trigger="focus"
               title="Subscription Required"
               data-bs-html="true"
               data-bs-content='You need to <a href="{% url "user_side:subcription_plan" %}">subscribe</a> to a plan to create courts.'>
                <i class="fa-solid fa-plus"></i> Add Court
            </a>
        {% else %}
            <a href="{% url 'user_side:add_my_court' %}" class="btn btn-primary"><i class="fa-solid fa-plus"></i> Add Court</a>
        {% endif %}
    </div>
</div>

<div id="map" style="height: 400px; width: 100%; border-radius: 10px;"></div>

<div class="d-flex flex-column flex-md-row justify-content-between align-items-center mt-4 mb-4">
    <input type="text" id="searchBar" class="form-control" placeholder="üîç Search court..." value="{{ query }}" style="max-width: 350px; border-radius: 20px;" onkeyup="filterCourts()">
    <div class="d-flex flex-column flex-md-row">
        <input type="text" id="locationSearch" class="form-control mt-2 mt-md-0 me-md-2" placeholder="üìç Search by location..." value="{{ location_query }}" style="max-width: 350px; border-radius: 20px;">
        <input type="hidden" id="latitudeSearch" name="latitude" value="{{ latitude }}">
        <input type="hidden" id="longitudeSearch" name="longitude" value="{{ longitude }}">
    </div>
</div>

<div class="row">
    {% for court in courts %}
        <div class="col-md-6 col-lg-4 mb-3">
            <div class="card shadow-sm p-3 {% if error %}deactivated{% endif %}">
                <div id="courtCarousel{{ court.id }}" class="carousel slide" data-bs-ride="carousel">
                    <div class="carousel-inner">
                        {% with court.courtimage_set.all as images %}
                            {% for image in images %}
                                <div class="carousel-item {% if forloop.first %}active{% endif %}">
                                    <img src="{{ image.image.url }}" class="d-block w-100 rounded court-image" alt="{{ court.name }}">
                                </div>
                            {% empty %}
                                <div class="carousel-item active">
                                    <img src="{% static 'images/default-court.jpg' %}" class="d-block w-100 rounded" alt="No Image">
                                </div>
                            {% endfor %}
                        {% endwith %}
                    </div>
                    {% if not error %}
                    <button class="carousel-control-prev" type="button" data-bs-target="#courtCarousel{{ court.id }}" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#courtCarousel{{ court.id }}" data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    </button>
                    {% endif %}
                </div>
                <div class="mt-3">
                    {% if error %}
                        <h5 class="mb-1 text-dark">{{ court.name }}</h5>
                    {% else %}
                        <h5 class="mb-1"><a href="{% url 'user_side:court_view' court.id %}" class="text-decoration-none text-dark">{{ court.name }}</a></h5>
                    {% endif %}
                    <p class="text-muted small mb-1">üìç {{ court.location }}</p>
                    <p class="text-muted small mb-1">üïí {{ court.open_time|default:"N/A" }} - {{ court.close_time|default:"N/A" }}</p>
                    <p class="text-muted small mb-1">‚≠ê Rating: {{ court.avg_rating|floatformat:1 }}</p>
                    <p class="text-muted small mb-1">üí∞ Booking Fee: {{ court.price }} {{ court.price_unit }}</p>
                </div>
            </div>
        </div>
    {% empty %}
        {% include 'base/not_found.html' %}
    {% endfor %}
</div>

{% if courts.has_other_pages %}
<nav aria-label="Court pagination">
    <ul class="pagination justify-content-center mt-4">
        {% if courts.has_previous %}
        <li class="page-item">
            <a class="page-link" href="?page=1{% if query %}&q={{ query }}{% endif %}{% if location_query %}&location={{ location_query }}{% endif %}{% if latitude %}&latitude={{ latitude }}{% endif %}{% if longitude %}&longitude={{ longitude }}{% endif %}">¬´ First</a>
        </li>
        <li class="page-item">
            <a class="page-link" href="?page={{ courts.previous_page_number }}{% if query %}&q={{ query }}{% endif %}{% if location_query %}&location={{ location_query }}{% endif %}{% if latitude %}&latitude={{ latitude }}{% endif %}{% if longitude %}&longitude={{ longitude }}{% endif %}">Previous</a>
        </li>
        {% endif %}
        {% for num in courts.paginator.page_range %}
        {% if courts.number == num %}
        <li class="page-item active"><span class="page-link">{{ num }}</span></li>
        {% elif num > courts.number|add:'-2' and num < courts.number|add:'2' %}
        <li class="page-item">
            <a class="page-link" href="?page={{ num }}{% if query %}&q={{ query }}{% endif %}{% if location_query %}&location={{ location_query }}{% endif %}{% if latitude %}&latitude={{ latitude }}{% endif %}{% if longitude %}&longitude={{ longitude }}{% endif %}">{{ num }}</a>
        </li>
        {% endif %}
        {% endfor %}
        {% if courts.has_next %}
        <li class="page-item">
            <a class="page-link" href="?page={{ courts.next_page_number }}{% if query %}&q={{ query }}{% endif %}{% if location_query %}&location={{ location_query }}{% endif %}{% if latitude %}&latitude={{ latitude }}{% endif %}{% if longitude %}&longitude={{ longitude }}{% endif %}">Next</a>
        </li>
        <li class="page-item">
            <a class="page-link" href="?page={{ courts.paginator.num_pages }}{% if query %}&q={{ query }}{% endif %}{% if location_query %}&location={{ location_query }}{% endif %}{% if latitude %}&latitude={{ latitude }}{% endif %}{% if longitude %}&longitude={{ longitude }}{% endif %}">Last ¬ª</a>
        </li>
        {% endif %}
    </ul>
</nav>
{% endif %}
{% endblock %}

{% block scripts %}
<script async defer src="https://maps.googleapis.com/maps/api/js?key={{ google_api_key }}&libraries=places&callback=initMap"></script>
<script>
    let map;
    let markers = []; // Store markers to clear them later
    let userLat = 40.7128, userLng = -74.0060; // Default location (New York)
    let courts = JSON.parse('{{ courts_json|safe }}');

    function initMap() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(position => {
                userLat = position.coords.latitude;
                userLng = position.coords.longitude;
                initializeMap();
                initAutocomplete();
            }, error => {
                console.error("Geolocation error:", error.message);
                initializeMap();
                initAutocomplete();
            });
        } else {
            console.warn("Geolocation not supported by browser");
            initializeMap();
            initAutocomplete();
        }
    }

    function initializeMap() {
        map = new google.maps.Map(document.getElementById("map"), {
            center: { lat: userLat, lng: userLng },
            zoom: 12
        });
        plotSystemCourts(courts); // Plot initial courts
        fetchGoogleCourts();
    }

    function clearMarkers() {
        markers.forEach(marker => marker.setMap(null)); // Remove all markers
        markers = []; // Clear the markers array
    }

    function plotSystemCourts(courtsData) {
        clearMarkers(); // Clear existing markers
        courtsData.forEach(court => {
            const marker = new google.maps.Marker({
                position: { lat: parseFloat(court.latitude), lng: parseFloat(court.longitude) },
                map,
                title: court.name,
                icon: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png"
            });
            const infoWindow = new google.maps.InfoWindow({
                content: `<strong>${court.name}</strong><br>üìç ${court.location}`
            });
            marker.addListener("click", () => {
                infoWindow.open(map, marker);
            });
            markers.push(marker); // Store marker for later clearing
        });
    }

    function fetchGoogleCourts() {
        fetch(`/user_side/fetch_pickleball_courts?lat=${userLat}&lng=${userLng}`)
            .then(response => response.json())
            .then(data => {
                data.pickleball_courts.forEach(court => {
                    const marker = new google.maps.Marker({
                        position: { lat: court.latitude, lng: court.longitude },
                        map,
                        title: court.name,
                        icon: "http://maps.google.com/mapfiles/ms/icons/red-dot.png"
                    });
                    const infoWindow = new google.maps.InfoWindow({
                        content: `<strong>${court.name}</strong>`
                    });
                    marker.addListener("click", () => {
                        infoWindow.open(map, marker);
                    });
                    markers.push(marker);
                });
            })
            .catch(error => console.error("Error fetching Google courts:", error));
    }

    function filterCourts() {
        let searchQuery = document.getElementById('searchBar').value.trim();
        if (event.key === "Enter") {
            let url = `?q=${encodeURIComponent(searchQuery)}`;
            if (document.getElementById('locationSearch').value) {
                url += `&location=${encodeURIComponent(document.getElementById('locationSearch').value)}`;
            }
            if (document.getElementById('latitudeSearch').value && document.getElementById('longitudeSearch').value) {
                url += `&latitude=${document.getElementById('latitudeSearch').value}&longitude=${document.getElementById('longitudeSearch').value}`;
            }
            window.location.href = url;
        }
    }

    function filterCourtByLocation() {
        let locationQuery = document.getElementById('locationSearch').value.trim();
        let latitude = document.getElementById('latitudeSearch').value.trim();
        let longitude = document.getElementById('longitudeSearch').value.trim();
        if ((event && event.key === "Enter") || !event) {
            let url = '?';
            if (locationQuery) {
                url += `location=${encodeURIComponent(locationQuery)}`;
            }
            if (latitude && longitude) {
                url += (url === '?' ? '' : '&') + `latitude=${latitude}&longitude=${longitude}`;
            }
            if ('{{ query }}') {
                url += (url === '?' ? '' : '&') + `q={{ query }}`;
            }
            window.location.href = url === '?' ? window.location.pathname : url;
        }
    }

    function initAutocomplete() {
        const input = document.getElementById("locationSearch");
        if (!input) {
            console.error("Location search input not found");
            return;
        }
        if (!google || !google.maps || !google.maps.places) {
            console.error("Google Maps Places API not loaded");
            return;
        }

        const autocomplete = new google.maps.places.Autocomplete(input, {
            types: ['geocode'],
            fields: ['geometry', 'formatted_address']
        });

        autocomplete.addListener('place_changed', () => {
            const place = autocomplete.getPlace();
            if (!place.geometry || !place.geometry.location) {
                console.warn("No geometry available for selected place");
                document.getElementById("latitudeSearch").value = "";
                document.getElementById("longitudeSearch").value = "";
                return;
            }

            // Populate hidden fields
            document.getElementById("latitudeSearch").value = place.geometry.location.lat();
            document.getElementById("longitudeSearch").value = place.geometry.location.lng();

            // Update map center
            userLat = place.geometry.location.lat();
            userLng = place.geometry.location.lng();
            map.setCenter({ lat: userLat, lng: userLng });
            map.setZoom(12);

            // Trigger filter to update card list and map
            filterCourtByLocation();
        });

        console.log("Autocomplete initialized for locationSearch");
    }
</script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const popoverTrigger = document.getElementById('subscribe-btn');
        if (popoverTrigger) {
            new bootstrap.Popover(popoverTrigger);
        }
        document.getElementById('locationSearch').addEventListener('keyup', filterCourtByLocation);
    });
</script>
{% endblock %}