{% extends 'base/base_user.html' %}
{% load static %}

{% block content %}
<div class="container-fluid px-4">
    <h1 class="h3 mb-4 text-center">Create Event</h1>

    <div class="nw-form">
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}

        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="mb-3">
                <label for="event_name" class="form-label">Event Name</label>
                <input type="text" class="form-control" id="event_name" name="event_name" required value="{{ event_data.event_name|default_if_none:'' }}">
            </div>
            <div class="mb-3">
                <label for="event_description" class="form-label">Event Description</label>
                <textarea class="form-control" id="event_description" name="event_description" rows="4" required>{{ event_data.event_description|default_if_none:'' }}</textarea>
            </div>
            <div class="mb-3">
                <label for="event_image" class="form-label">Event Image</label>
                <input type="file" class="form-control" id="event_image" name="event_image" accept="image/*">
            </div>
            <div class="mb-3">
                <label for="location" class="form-label">Event Location</label>
                <input type="text" class="form-control" id="location" name="location" placeholder="Enter a location" required value="{{ event_data.location|default_if_none:'' }}">
                <input type="hidden" id="latitude" name="latitude" value="{{ event_data.latitude|default_if_none:'' }}">
                <input type="hidden" id="longitude" name="longitude" value="{{ event_data.longitude|default_if_none:'' }}">
            </div>
            <div class="mb-3">
                <label for="max_team" class="form-label">Maximum Teams</label>
                <input type="number" class="form-control" id="max_team" name="max_team" min="1" required value="{{ event_data.max_team|default_if_none:'' }}">
            </div>
            <div class="mb-3">
                <label for="total_fee" class="form-label">Total Event Fee</label>
                <input type="number" class="form-control" name="total_fee" id="total_fee" min="0" step="0.01" required value="{{ event_data.total_fee|default_if_none:'' }}">
            </div>
            <div class="mb-3">
                <label class="form-label d-flex align-items-center justify-content-between">
                    <span>Extra Fees (Optional)</span>
                    <button type="button" class="btn btn-outline-secondary btn-sm add-extra-fee">+</button>
                </label>
                <div id="extra_fees_container"></div>
            </div>
            <div class="mb-3">
                <label class="form-label">Event Registration Start/End</label>
                <div class="row">
                    <div class="col-12 col-md-6 mb-2 mb-md-0">
                        <input type="datetime-local" class="form-control" name="registration_start" required value="{{ event_data.registration_start|default_if_none:'' }}">
                    </div>
                    <div class="col-12 col-md-6">
                        <input type="datetime-local" class="form-control" name="registration_end" required value="{{ event_data.registration_end|default_if_none:'' }}">
                    </div>
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">Event Start/End</label>
                <div class="row">
                    <div class="col-12 col-md-6 mb-2 mb-md-0">
                        <input type="datetime-local" class="form-control" name="event_start" required value="{{ event_data.event_start|default_if_none:'' }}">
                    </div>
                    <div class="col-12 col-md-6">
                        <input type="datetime-local" class="form-control" name="event_end" required value="{{ event_data.event_end|default_if_none:'' }}">
                    </div>
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">Rank Range (Optional)</label>
                <div class="row">
                    <div class="col-12 col-md-6 mb-2 mb-md-0">
                        <input type="number" class="form-control" name="start_rank" step="0.01" value="{{ event_data.start_rank|default_if_none:'' }}">
                    </div>
                    <div class="col-12 col-md-6">
                        <input type="number" class="form-control" name="end_rank" step="0.01" value="{{ event_data.end_rank|default_if_none:'' }}">
                    </div>
                </div>
            </div>
            <div class="mb-3">
                <label for="reg_type" class="form-label">Event Registration Type</label>
                <select class="form-select" name="registration_type" id="reg_type" required>
                    <option value="" disabled {% if not event_data.registration_type %}selected{% endif %}>-- Select --</option>
                    {% for league_type in league_type_choices %}
                        <option value="{{ league_type }}" {% if event_data.registration_type == league_type %}selected{% endif %}>{{ league_type }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label d-flex align-items-center justify-content-between">
                    <span>Play Configuration</span>
                    <button type="button" class="btn btn-outline-secondary btn-sm add-combo">+</button>
                </label>
                <div id="combo_container">
                    <div class="combo-section mt-2 p-3 border rounded">
                        <div class="row gx-2 gy-2 combo-row">
                            <div class="col-12 col-md-4 col-lg-2">
                                <select class="form-select combo-play-type" title="Select Play Type" name="play_type[]" required>
                                    <option value="" disabled selected>Play Type</option>
                                    {% for play_type in play_type_choices %}
                                        <option value="{{ play_type }}" {% if event_data.play_configs.0.play_type == play_type %}selected{% endif %}>{{ play_type }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-12 col-md-4 col-lg-2">
                                <select class="form-select combo-team-type" title="Select Team Type" name="team_type[]" required>
                                    <option value="" disabled selected>Team Type</option>
                                    {% for team_type in team_type_choices %}
                                        <option value="{{ team_type.name }}" {% if event_data.play_configs.0.team_type == team_type.name %}selected{% endif %}>{{ team_type.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-12 col-md-4 col-lg-2">
                                <select class="form-select combo-player-type" title="Select Player Type" name="player_type[]" required>
                                    <option value="" disabled selected>Player Type</option>
                                    {% for person_type in person_type_choices %}
                                        <option value="{{ person_type.name }}" {% if event_data.play_configs.0.player_type == person_type.name %}selected{% endif %}>{{ person_type.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="mt-3">
                            <label class="form-label">Round Robin</label>
                            <div class="row gx-2 gy-2">
                                <div class="col-4 col-md-2">
                                    <input type="number" class="form-control" name="court_round_robin[]" placeholder="Courts" min="1" required value="{{ event_data.play_configs.0.round_robin.court|default_if_none:'' }}">
                                </div>
                                <div class="col-4 col-md-2">
                                    <input type="number" class="form-control" name="set_round_robin[]" placeholder="Sets" min="1" required value="{{ event_data.play_configs.0.round_robin.set|default_if_none:'' }}">
                                </div>
                                <div class="col-4 col-md-2">
                                    <input type="number" class="form-control" name="point_round_robin[]" placeholder="Points" min="1" required value="{{ event_data.play_configs.0.round_robin.point|default_if_none:'' }}">
                                </div>
                            </div>
                            <label class="form-label mt-2">Elimination</label>
                            <div class="row gx-2 gy-2">
                                <div class="col-4 col-md-2">
                                    <input type="number" class="form-control" name="court_elimination[]" placeholder="Courts" min="1" required value="{{ event_data.play_configs.0.elimination.court|default_if_none:'' }}">
                                </div>
                                <div class="col-4 col-md-2">
                                    <input type="number" class="form-control" name="set_elimination[]" placeholder="Sets" min="1" required value="{{ event_data.play_configs.0.elimination.set|default_if_none:'' }}">
                                </div>
                                <div class="col-4 col-md-2">
                                    <input type="number" class="form-control" name="point_elimination[]" placeholder="Points" min="1" required value="{{ event_data.play_configs.0.elimination.point|default_if_none:'' }}">
                                </div>
                            </div>
                            <label class="form-label mt-2">Final</label>
                            <div class="row gx-2 gy-2">
                                <div class="col-4 col-md-2">
                                    <input type="number" class="form-control" name="court_final[]" placeholder="Courts" min="1" required value="{{ event_data.play_configs.0.final.court|default_if_none:'' }}">
                                </div>
                                <div class="col-4 col-md-2">
                                    <input type="number" class="form-control" name="set_final[]" placeholder="Sets" min="1" required value="{{ event_data.play_configs.0.final.set|default_if_none:'' }}">
                                </div>
                                <div class="col-4 col-md-2">
                                    <input type="number" class="form-control" name="point_final[]" placeholder="Points" min="1" required value="{{ event_data.play_configs.0.final.point|default_if_none:'' }}">
                                </div>
                            </div>
                            <div class="row gx-2 gy-2 mt-3">
                                <div class="col-12 col-md-2">
                                    <button type="button" class="btn btn-outline-danger btn-sm remove-combo w-100">−</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label d-flex justify-content-between">
                    <span>Cancellation Policy (Optional)</span>
                    <button type="button" class="btn btn-outline-secondary btn-sm add-cancel-policy">+</button>
                </label>
                <div id="cancel_policy_container"></div>
            </div>
            <button type="submit" class="btn btn-primary">Submit</button>
        </form>
    </div>

</div>

<style>
    /* form {
        max-width: 100%;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: .25rem;
    } */
    .combo-section {
        border: 1px solid #dee2e6;
        border-radius: .25rem;
        margin-bottom: 15px;
    }
    .btn-sm {
        padding: .25rem .5rem;
        font-size: .875rem;
    }
    @media (max-width: 576px) {
        .combo-row .col-4 {
            flex: 0 0 33.333333%;
            max-width: 33.333333%;
        }
        .form-control, .form-select {
            font-size: 0.9rem;
        }
    }
</style>
{% endblock %}

{% block scripts %}
<script src="https://maps.googleapis.com/maps/api/js?key={{ MAP_API_KEY }}&libraries=places"></script>
<script>
    function initAutocomplete() {
        const input = document.getElementById('location');
        const autocomplete = new google.maps.places.Autocomplete(input);

        autocomplete.addListener('place_changed', function() {
            const place = autocomplete.getPlace();
            if (place.geometry) {
                document.getElementById('latitude').value = place.geometry.location.lat();
                document.getElementById('longitude').value = place.geometry.location.lng();
            }
        });
    }

    window.addEventListener('load', initAutocomplete);
</script>

<script>
    // Add Extra Fee Row
    document.querySelector('.add-extra-fee').addEventListener('click', function() {
        const container = document.getElementById('extra_fees_container');
        const row = document.createElement('div');
        row.className = 'row gx-2 mb-2 align-items-center';
        
        row.innerHTML = `
            <div class="col-12 col-md-4">
                <input type="text" name="extra_fee_name[]" class="form-control" placeholder="Fee Name">
            </div>
            <div class="col-12 col-md-4">
                <input type="number" name="extra_fee_amount[]" class="form-control" placeholder="Fee Amount" min="0" step="0.01">
            </div>
            <div class="col-12 col-md-2">
                <button type="button" class="btn btn-outline-danger btn-sm remove-extra-fee w-100">−</button>
            </div>
        `;
        container.appendChild(row);
    });

    // Add Cancellation Policy Row
    document.querySelector('.add-cancel-policy').addEventListener('click', function() {
        const container = document.getElementById('cancel_policy_container');
        const row = document.createElement('div');
        row.className = 'row gx-2 mb-2 align-items-center';
        
        row.innerHTML = `
            <div class="col-12 col-md-4">
                <input type="number" name="cancel_duration[]" class="form-control" placeholder="Duration (days)" min="0" title="Number of days before event">
            </div>
            <div class="col-12 col-md-4">
                <input type="number" name="cancel_percentage[]" class="form-control" placeholder="Refund %" min="0" max="100" step="0.01" title="Refund percentage">
            </div>
            <div class="col-12 col-md-2">
                <button type="button" class="btn btn-outline-danger btn-sm remove-cancel-policy w-100">−</button>
            </div>
        `;
        container.appendChild(row);
    });

    // Add Play Configuration Section
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('add-combo')) {
            const container = document.getElementById('combo_container');
            const section = container.querySelector('.combo-section').cloneNode(true);
            
            // Clear input values in cloned section
            section.querySelectorAll('input').forEach(input => input.value = '');
            section.querySelectorAll('select').forEach(select => select.selectedIndex = 0);
            
            container.appendChild(section);
        } else if (e.target.classList.contains('remove-combo')) {
            const sections = document.querySelectorAll('.combo-section');
            if (sections.length > 1) {
                e.target.closest('.combo-section').remove();
            }
        } else if (e.target.classList.contains('remove-extra-fee')) {
            e.target.closest('.row').remove();
        } else if (e.target.classList.contains('remove-cancel-policy')) {
            e.target.closest('.row').remove();
        }
    });

    // Initialize Bootstrap tooltips
    document.addEventListener('DOMContentLoaded', function() {
        const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        tooltipTriggerList.forEach(tooltipTriggerEl => {
            new bootstrap.Tooltip(tooltipTriggerEl);
        });
    });
</script>
{% endblock %}