{% extends "base_store.html" %}
{% load i18n %}
{% load static %}
{% block extra_css %}
    <style xmlns="http://www.w3.org/1999/html">
    </style>
{% endblock %}
{% block page_title %}
    Product
{% endblock %}
{% block content %}
<style>
/* ✅ Make carousel images scale */
#productCarousel img {
    object-fit: contain;
    max-height: 400px;
}

/* ✅ Space out buttons better on small screens */
.action-buttons {
    flex-wrap: wrap;
    gap: 0.5rem;
}

/* ✅ Make quantity input not shrink weirdly */
.quantity-group {
    width: 120px;
}

/* ✅ On mobile: stack actions vertically */
@media (max-width: 576px) {
    .action-buttons {
        flex-direction: column;
        align-items: stretch;
    }
    .quantity-group {
        width: 100%;
    }
}

/* ✅ Ratings images responsive */
#latest-ratings img,
#all-ratings img {
    max-width: 100%;
    height: auto;
}
</style>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<div id="alert-container" style="position: fixed; top: 30px; right: 20px; z-index: 1055; width: auto;"></div>
<div class="page-breadcrumb">
    <div class="row">
        <div class="col-12 d-flex no-block align-items-center">
            <h4 class="page-title">Product details</h4>
            <div class="ml-auto text-right">
                <nav aria-label="breadcrumb">
                    
                </nav>
            </div>
        </div>
    </div>
</div>
<title>{{ product.name }}</title>

<div class="container my-4">
    <div class="d-flex justify-content-end mb-3">
        <a href="{% url 'dashboard:product_list' %}" class="btn btn-secondary me-3"><i class="fa fa-arrow-left"></i></a>
        <a href="{% url 'dashboard:edit_product' product.id %}" class="btn btn-primary"><i class="fa fa-edit"></i></a>
    </div>
    <div class="row">
        <div class="col-md-6">
            <!-- Carousel -->
            <div id="productCarousel" class="carousel slide" data-bs-ride="carousel">
                <div class="carousel-inner">
                    {% for image in images %}
                    <div class="carousel-item {% if forloop.first %}active{% endif %}">
                        <img src="{{ image.image.url }}" class="d-block w-100" alt="Product Image">
                    </div>
                    {% endfor %}
                </div>
                <button class="carousel-control-prev" type="button" data-bs-target="#productCarousel" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon"></span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#productCarousel" data-bs-slide="next">
                    <span class="carousel-control-next-icon"></span>
                </button>
            </div>
        </div>

        <div class="col-md-6">
            <h2>{{ product.name }}</h2>
            <div style="position: relative; display: inline-block; width: 80px; line-height: 1; font-size: 16px;">
                <!-- Gray base stars -->
                <div style="color: #ccc;">
                    ★★★★★
                </div>
                <!-- Gold overlay stars -->
                <div style="
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: {{ product.star_percentage }}%;
                    white-space: nowrap;
                    overflow: hidden;
                    color: #f5a623;
                ">
                    ★★★★★
                </div>
            </div>

            <!-- Reviews count -->
            <span style="margin-left: 3px; color: #555;">
                ({{ product.rating_count|default:0 }} reviews)
            </span>
            <p>{{ product.description }}</p>

            <div>
                <strong>Price:</strong>
                <span id="old_price" style="text-decoration:line-through;"></span>
                <span id="current_price" class="ms-2 fw-bold text-success"></span>
                <span id="discount" class="ms-2 text-danger"></span>
            </div>

            <div class="my-2">
                {% if sizes %}
                    <label class="fw-bold">Size:</label>
                    <div id="sizeOptions" class="btn-group mb-3" role="group">
                        {% for size in sizes %}
                            <input type="radio" class="btn-check size-input" name="size" id="size-{{ size }}" value="{{ size }}" autocomplete="off">
                            <label class="btn btn-outline-secondary me-1" for="size-{{ size }}">{{ size }}</label>
                        {% endfor %}
                    </div>
                {% endif %}

                {% if colors %}
                    <label class="fw-bold">Color:</label>
                    <div id="colorOptions" class="btn-group mb-3" role="group">
                        {% for color in colors %}
                            <input type="radio" class="btn-check color-input" name="color" id="color-{{ color }}" value="{{ color }}" autocomplete="off">
                            <label class="btn btn-outline-secondary me-1 color-label" for="color-{{ color }}">{{ color }}</label>
                        {% endfor %}
                    </div>
                {% endif %}

                <div id="availability" class="mt-2 text-primary fw-semibold"></div>
                <div id="stockMessage" class="text-danger fw-bold mt-2"></div>
                {% if not is_button %}
                <hr class="my-4">

                <div class="d-flex align-items-center gap-3">
                    <!-- ❤️ Wishlist -->
                    {% if not wishlist_status %}
                    <button id="wishlistBtn" class="btn btn-outline-danger" onclick="addToWishlist({{ product.id }})">
                        <i class="fa fa-heart"></i>
                    </button>
                    {% else %}
                    <button id="wishlistBtn" class="btn btn-danger text-white" onclick="addToWishlist({{ product.id }})">
                        <i class="fa fa-heart"></i>
                    </button>
                    {% endif %}

                    <!-- Quantity Selector -->
                    <div class="input-group" style="width: 120px;">
                        <button class="btn btn-outline-secondary" type="button" onclick="changeQuantity(-1)">-</button>
                        <input type="number" id="quantityInput" class="form-control text-center" value="1" min="1">
                        <button class="btn btn-outline-secondary" type="button" onclick="changeQuantity(1)">+</button>
                    </div>

                    <!-- Add to Cart -->
                    <button class="btn btn-success text-white" onclick="addToCart({{ product.id }})">
                        <i class="fa fa-shopping-cart"></i> Add to Cart
                    </button>

                    <!-- Buy Now -->
                    <button class="btn btn-warning text-dark fw-bold" onclick="buyNow({{ product.id }})">
                        <i class="fa fa-bolt"></i> Buy Now
                    </button>
                </div>
                {% endif %}
                <div id="highlights" class="mt-3" {% if not default_highlights %}style="display: none;"{% endif %}>
                    <h5>Highlights</h5>
                    <ul id="highlight_list">
                        {% for h in default_highlights %}
                            <li><strong>{{ h.highlight_key }}</strong>: {{ h.highlight_des }}</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <hr>

    <h4>Reviews ({{ product.rating }}/5)</h4>
    <div id="latest-ratings" class="mb-5">
        {% for rate in ratings %}
            <div class="border p-2 mb-3">
                <strong>{{ forloop.counter }}. {{ rate.user.first_name }}</strong>
                rated:
                {% for i in "12345" %}
                    {% if i|add:"0" <= rate.rating %}
                        <i class="bi bi-star-fill text-warning"></i>
                    {% elif i|add:"0" <= rate.rating|add:"0.5" %}
                        <i class="bi bi-star-half text-warning"></i>
                    {% else %}
                        <i class="bi bi-star text-warning"></i>
                    {% endif %}
                {% endfor %}
                <br>
                <small>{{ rate.created_at }}</small>
                <p>{{ rate.comment }}</p>
                <div class="d-flex flex-wrap">
                    {% for img in rate.ratingImages.all %}
                        <img src="{{ img.image.url }}" style="width:100px; height:auto;" class="me-2 mb-2">
                    {% endfor %}
                </div>
            </div>
        {% empty %}
            <p>No ratings yet.</p>
        {% endfor %}
    </div>


<!-- Scrollable all ratings (hidden initially) -->
    <div id="all-ratings"  style="display: none; max-height: 400px; overflow-y: auto;">
       {% for rate in all_ratings %}
            <div class="border p-2 mb-3">
                <strong>{{ forloop.counter }}. {{ rate.user.first_name }}</strong> rated:
                {% with full_stars=rate.rating|floatformat:1 %}
                    {% for i in "12345" %}
                        {% if i|add:"0" <= rate.rating %}
                            <i class="bi bi-star-fill text-warning"></i>
                        {% elif i|add:"-0.5" < rate.rating and i|add:"0" > rate.rating %}
                            <i class="bi bi-star-half text-warning"></i>
                        {% else %}
                            <i class="bi bi-star text-warning"></i>
                        {% endif %}
                    {% endfor %}
                {% endwith %}
                <br>
                <small>{{ rate.created_at }}</small>
                <p>{{ rate.comment }}</p>
                <div class="d-flex flex-wrap">
                    {% for img in rate.ratingImages.all %}
                        <img src="{{ img.image.url }}" style="width:100px; height:auto;" class="me-2 mb-2">
                    {% endfor %}
                </div>
            </div>
        {% endfor %}
    </div>
    {% if all_ratings|length > 5 %}
        <button class="btn btn-outline-primary" id="toggle-ratings-btn" onclick="toggleRatings()">See More</button>
    {% endif %}
</div>

<script id="sizeColorMapJson" type="application/json">{{ size_color_map|safe }}</script>
<script>
    const sizeColorMap = JSON.parse(document.getElementById('sizeColorMapJson').textContent);
    const sizeInputs = document.querySelectorAll('.size-input');
    const colorInputs = document.querySelectorAll('.color-input');
    const stockMessage = document.getElementById('stockMessage');

    function getAvailableColors(size) {
        return sizeColorMap.filter(entry => entry.size === size).map(e => e.color);
    }

    function getAvailableSizes(color) {
        return sizeColorMap.filter(entry => entry.color === color).map(e => e.size);
    }

    function markUnavailableColors(selectedSize) {
        const availableColors = getAvailableColors(selectedSize);
        colorInputs.forEach(input => {
            const label = document.querySelector(`label[for="${input.id}"]`);
            if (!availableColors.includes(input.value)) {
                label.classList.add('text-decoration-line-through', 'text-muted');
            } else {
                label.classList.remove('text-decoration-line-through', 'text-muted');
            }
        });
    }

    function markUnavailableSizes(selectedColor) {
        const availableSizes = getAvailableSizes(selectedColor);
        sizeInputs.forEach(input => {
            const label = document.querySelector(`label[for="${input.id}"]`);
            if (!availableSizes.includes(input.value)) {
                label.classList.add('text-decoration-line-through', 'text-muted');
            } else {
                label.classList.remove('text-decoration-line-through', 'text-muted');
            }
        });
    }

    function checkStockAndShowMessage() {
        let size = $('input[name="size"]:checked').val() || null;
        let color = $('input[name="color"]:checked').val() || null;

        const match = sizeColorMap.find(entry =>
            (!size || entry.size === size) &&
            (!color || entry.color === color)
        );

        if (match) {
            stockMessage.innerText = "";
        } else {
            stockMessage.innerText = "Out of stock for selected option.";
        }
    }

    function fetchSpecification() {
        let size = $('input[name="size"]:checked').val();
        let color = $('input[name="color"]:checked').val();
        let product_id = '{{ product.id }}';

        $.ajax({
            url: "{% url 'dashboard:get_specification_data' %}",
            data: { product_id, size, color },
            success: function(response) {
                if (response.success) {
                    $('#old_price').text('₹' + response.old_price);
                    $('#current_price').text('₹' + response.current_price);
                    $('#discount').text(response.discount + '% off');
                    $('#availability').text('Available: ' + response.available_product);

                    if (response.available_product > 0) {
                        $('#stockMessage').text('');
                        $('.btn-success, .btn-warning').prop('disabled', false);
                    } else {
                        $('#stockMessage').text('Out of stock');
                        $('.btn-success, .btn-warning').prop('disabled', true);
                    }

                    let highlights = '';
                    response.highlights.forEach(item => {
                        highlights += `<li><strong>${item.highlight_key}</strong>: ${item.highlight_des}</li>`;
                    });
                    $('#highlight_list').html(highlights);
                } else {
                    $('#old_price, #current_price, #discount, #availability').text('');
                    $('#highlight_list').empty();
                    $('#stockMessage').text("Out of stock for this option.");
                    $('.btn-success, .btn-warning').prop('disabled', true);
                }
            }
        });
    }

    sizeInputs.forEach(input => {
        input.addEventListener('change', () => {
            markUnavailableColors(input.value);
            $('label[for="' + input.id + '"]').removeClass('text-decoration-line-through text-muted');
            checkStockAndShowMessage();
            fetchSpecification();
        });
    });

    colorInputs.forEach(input => {
        input.addEventListener('change', () => {
            markUnavailableSizes(input.value);
            $('label[for="' + input.id + '"]').removeClass('text-decoration-line-through text-muted');
            checkStockAndShowMessage();
            fetchSpecification();
        });
    });

    document.addEventListener('DOMContentLoaded', function () {
        if (sizeInputs.length > 0) sizeInputs[0].checked = true;
        if (colorInputs.length > 0) colorInputs[0].checked = true;

        if (sizeInputs.length > 0) markUnavailableColors(sizeInputs[0].value);
        if (colorInputs.length > 0) markUnavailableSizes(colorInputs[0].value);

        fetchSpecification();
    });
</script>

<script>
    function toggleRatings() {
        const allRatings = document.getElementById("all-ratings");
        const latestRatings = document.getElementById("latest-ratings");
        const btn = document.getElementById("toggle-ratings-btn");

        if (allRatings.style.display === "none") {
            allRatings.style.display = "block";
            latestRatings.style.display = "none";
            btn.innerText = "Show Less";
        } else {
            allRatings.style.display = "none";
            latestRatings.style.display = "block";
            btn.innerText = "See More";
        }
    }
</script>
<script>
    function changeQuantity(delta) {
        let input = document.getElementById('quantityInput');
        let current = parseInt(input.value) || 1;
        current = Math.max(1, current + delta);
        input.value = current;
    }

    function showAlert(message, type = "success") {
        let alertId = "alert-" + Date.now(); // unique ID
        let alertHTML = `
            <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show shadow" role="alert" style="min-width: 250px;">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;
        $("#alert-container").append(alertHTML);

        // Auto-remove after 3 seconds
        setTimeout(() => {
            $("#" + alertId).alert('close');
        }, 3000);
    }

    function addToWishlist(productId) {
        $.ajax({
            url: "{% url 'dashboard:add_to_wishlist' %}",  // adjust this name
            method: "POST",
            data: {
                'product_id': productId,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.success) {
                    showAlert(response.message, "success");
                    setTimeout(() => location.reload(), 1000); // small delay before refresh
                } else {
                    showAlert(response.message || "Something went wrong.", "danger");
                }
            },
            error: function() {
                showAlert("An error occurred.", "danger");
            }
        });
    }

    function addToCart(productId) {
        const qty = document.getElementById('quantityInput').value;
        const size = $('input[name="size"]:checked').val();
        const color = $('input[name="color"]:checked').val();

        $.ajax({
            url: "{% url 'dashboard:add_to_cart' %}",  // adjust this name
            method: "POST",
            data: {
                'product_id': productId,
                'quantity': qty,
                'size': size,
                'color': color,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.success) {
                    showAlert("Product added to cart!", "success");
                } else {
                    showAlert(response.message || "Error adding to cart.", "danger");
                }
            },
            error: function() {
                showAlert("An error occurred while adding to cart.", "danger");
            }
        });
    }

    function buyNow(productId) {
        const qty = document.getElementById('quantityInput').value;
        const size = $('input[name="size"]:checked').val();
        const color = $('input[name="color"]:checked').val();

        // Redirect with query parameters
        const url = `{% url 'dashboard:buy_now' %}?product_id=${productId}&quantity=${qty}&size=${size}&color=${color}`;
        window.location.href = url;
    }
</script>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
{% endblock %}