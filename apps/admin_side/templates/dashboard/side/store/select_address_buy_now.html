{% extends "base_store.html" %}
{% load static %}

{% block content %}
<style>
.pac-container {
    z-index: 2000 !important; /* higher than modal (1050 default) */
}
</style>
<script src="https://maps.googleapis.com/maps/api/js?key={{MAP_API_KEY}}&libraries=places"></script>
<div class="container mt-3">
    <h3>Select Delivery Address</h3>

    {% if addresses %}
        <form method="post" >
            {% csrf_token %}
            {% for address in addresses %}
                <div class="card p-4 mb-2 mt-3">
                    <label>
                        <input type="radio" name="selected_address" value="{{ address.id }}" {% if address.default_address %}checked{% endif %}>
                        {{ address.complete_address }}
                    </label>
                </div>
            {% endfor %}
            <input type="hidden" name="grand_total" value="{{ grand_total }}">
            <div class="d-flex justify-content-between align-items-center mt-3 flex-wrap gap-2">
                <button type="submit" class="btn btn-primary">Continue</button>
                <button type="button" class="btn btn-success" data-toggle="modal" data-target="#addAddressModal">Add Address</button>
            </div>
        </form>
    {% else %}
        {% include 'dashboard/not_found.html' %}
        <div class="text-center">
            <button class="btn btn-success" data-toggle="modal" data-target="#addAddressModal">Add Address</button>
        </div>
    {% endif %}
</div>

<div class="modal fade" id="addAddressModal" tabindex="-1" role="dialog" aria-labelledby="addAddressModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <form id="addAddressForm" method="POST" action="{% url 'dashboard:add_address_ajax' %}">
        {% csrf_token %}
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Address</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                
                <!-- Google Autocomplete Field -->
                <input type="text" id="autocomplete" placeholder="Search Location" class="form-control mb-2">

                <!-- Street Field (extra) -->
                <input type="text" name="street" placeholder="Street" class="form-control mb-2">

                <!-- Auto-filled Fields -->
                <input type="text" name="city" id="city" placeholder="City" class="form-control mb-2" readonly>
                <input type="text" name="state" id="state" placeholder="State" class="form-control mb-2" readonly>
                <input type="text" name="postal_code" id="postal_code" placeholder="Postal Code" class="form-control mb-2" readonly>
                <input type="text" name="country" id="country" placeholder="Country" class="form-control mb-2" readonly>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary">Add Address</button>
            </div>
        </div>
    </form>
  </div>
</div>

<script>
function initAutocomplete() {
    const autocompleteInput = document.getElementById('autocomplete');
    const autocomplete = new google.maps.places.Autocomplete(autocompleteInput, {
        types: ['geocode'] // You can use ['address'] for more precise results
    });

    autocomplete.addListener('place_changed', function () {
        const place = autocomplete.getPlace();
        let city = '', state = '', postal_code = '', country = '';

        if (place.address_components) {
            place.address_components.forEach(component => {
                const types = component.types;
                if (types.includes('locality')) {
                    city = component.long_name;
                }
                if (types.includes('administrative_area_level_1')) {
                    state = component.long_name;
                }
                if (types.includes('postal_code')) {
                    postal_code = component.long_name;
                }
                if (types.includes('country')) {
                    country = component.long_name;
                }
            });
        }

        // Fill in fields
        document.getElementById('city').value = city;
        document.getElementById('state').value = state;
        document.getElementById('postal_code').value = postal_code;
        document.getElementById('country').value = country;
    });
}

// Run after Google script is loaded
google.maps.event.addDomListener(window, 'load', initAutocomplete);


// AJAX form submission
document.getElementById('addAddressForm').addEventListener('submit', function(e) {
    e.preventDefault();
    let form = this;

    fetch(form.action, {
        method: 'POST',
        body: new FormData(form),
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    }).then(response => response.json())
      .then(data => {
          if (data.success) {
              location.reload();
          } else {
              alert(data.message || 'Failed to add address');
          }
      });
});
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}
