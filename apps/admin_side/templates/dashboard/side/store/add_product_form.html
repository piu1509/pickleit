{% extends "base_store.html" %}
{% load i18n %}
{% load static %}
{% block extra_css %}
    <style xmlns="http://www.w3.org/1999/html">
    </style>
    
{% endblock %}
{% block page_title %}
    Product
{% endblock %}
{% block content %}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
<style>
    body { background-color: #f8f9fa; }
    .container { max-width: 900px; }
    .card { border: none; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    .form-label { font-weight: 500; display: flex; align-items: center; gap: 5px; }
    .form-label i { color: #6c757d; }
    .highlight-entry, .image-preview { margin-bottom: 1rem; }
    .image-preview img { max-width: 80px; max-height: 80px; margin-right: 8px; border-radius: 5px; }
    .variation-section { display: none; }
    .invalid-feedback { display: none; font-size: 0.8rem; }
    .is-invalid ~ .invalid-feedback { display: block; }
    .drop-zone { border: 2px dashed #6c757d; border-radius: 10px; padding: 20px; text-align: center; background-color: #fff; }
    .drop-zone.dragover { background-color: #e9ecef; }
    .variation-entry .form-control, .variation-entry .form-select { height: 35px; font-size: 0.9rem; }
    .variation-entry .form-label { font-size: 0.9rem; }
    .variation-entry textarea { height: 60px; }
    .btn-sm { font-size: 0.8rem; }
    .form-text { font-size: 0.8rem; color: #6c757d; }
    .variation-card { position: relative; margin-bottom: 1rem; }
    .variation-card .card-header { background-color: #f1f3f5; display: flex; justify-content: space-between; align-items: center; }
    .close-btn { font-size: 1rem; cursor: pointer; }
    .inline-fields { display: flex; gap: 1rem; flex-wrap: wrap; align-items: flex-start; }
    .inline-fields .field-group { flex: 1; min-width: 150px; }
    .select2-container--default .select2-selection--multiple { height: auto; min-height: 35px; }
    .select2-container--default .select2-selection--multiple .select2-selection__choice { font-size: 0.9rem; }
    .image-thumb {
        position: relative;
        display: inline-block;
    }
    .remove-image-btn {
        position: absolute;
        top: -5px;
        right: -5px;
        background: white;
        border-radius: 50%;
        padding: 0 5px;
        font-weight: bold;
        box-shadow: 0 0 2px #aaa;
    }
</style>

<div class="container mb-5">
        {% if messages %}
    {% for mess in messages %}
        <div class="alert alert-{{ mess.tags }} alert-dismissible fade show" role="alert">
        {{ mess }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"><i class='fa fa-times'></i></button>
        </div>
    {% endfor %}
    {% endif %}
    <div class="card p-4">
        <h2 class="mb-4 text-center">Add Product</h2>
        <form id="productForm" method="post" enctype="multipart/form-data" novalidate>
            {% csrf_token %}
            <!-- Product Name and Category Inline -->
            <div class="inline-fields mb-3">
                <div class="field-group">
                    <label for="productName" class="form-label"><i class="bi bi-tag"></i> Product Name <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="productName" name="productName" required>
                    <div class="invalid-feedback">Product name is required.</div>
                    <div class="form-text">Enter the name of the product.</div>
                </div>
                <div class="field-group">
                    <label for="productCategory" class="form-label"><i class="bi bi-list-ul"></i> Product Category <span class="text-danger">*</span></label>
                    <select class="form-select" id="productCategory" name="productCategory" required>
                        <option value="">Select a category</option>
                        {% for category in categories %}
                        <option value="{{category.id}}">{{category.name}}</option>
                        {% endfor %}
                    </select>
                    <div class="invalid-feedback">Please select a category.</div>
                    <div class="form-text">Choose the category that best fits the product.</div>
                </div>
            </div>

            <!-- Description and Specification Inline -->
            <div class="inline-fields mb-3">
                <div class="field-group">
                    <label for="description" class="form-label"><i class="bi bi-text-paragraph"></i> Description</label>
                    <textarea class="form-control" id="description" name="description" rows="4"></textarea>
                    <div class="form-text">Provide a detailed description of the product.</div>
                </div>
                <div class="field-group">
                    <label for="specification" class="form-label"><i class="bi bi-info-circle"></i> Specification</label>
                    <textarea class="form-control" id="specification" name="specification" rows="4"></textarea>
                    <div class="form-text">List technical specifications or features (e.g., dimensions, materials).</div>
                </div>
            </div>

            <!-- Events (Searchable Multiple Select) -->
            <div class="mb-3">
                <label for="events" class="form-label"><i class="bi bi-calendar-event"></i> Events (Searchable Multiple Select)</label>
                <select class="form-select js-select2" id="events" name="events" multiple>
                    {% for event in events %}
                    <option value="{{event.id}}">{{event.name}}</option>
                    {% endfor %}
                </select>
                <div class="form-text">Search and select events associated with this product.</div>
            </div>

            <!-- Variation Type -->
            <div class="mb-3">
                <label class="form-label"><i class="bi bi-sliders"></i> Variation Type <span class="text-danger">*</span></label>
                <div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="variationType" id="singleVariation" value="single" required>
                        <label class="form-check-label" for="singleVariation">Single</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="variationType" id="multipleVariation" value="multiple">
                        <label class="form-check-label" for="multipleVariation">Multiple</label>
                    </div>
                </div>
                <div class="invalid-feedback">Please select a variation type.</div>
                <div class="form-text">Choose whether the product has a single or multiple variations.</div>
            </div>

            <!-- Single Variation Fields -->
            <div id="singleVariationFields" class="variation-section">
                <h5><i class="bi bi-box"></i> Single Variation</h5>
                <div class="variation-card card">
                    <div class="card-header">
                        <span>Single Variation</span>
                        <i class="bi bi-x close-btn" onclick="document.getElementById('singleVariationFields').style.display='none';"></i>
                    </div>
                    <div class="card-body">
                        <div class="inline-fields">
                            <div class="field-group">
                                <label for="singleRegularPrice" class="form-label"><i class="bi bi-currency-dollar"></i> Regular Price</label>
                                <input type="number" class="form-control" id="singleRegularPrice" name="singleRegularPrice" min="0" step="0.01">
                                <div class="form-text">Enter the regular price.</div>
                            </div>
                            <div class="field-group">
                                <label for="singleSalePrice" class="form-label"><i class="bi bi-tag-fill"></i> Sale Price</label>
                                <input type="number" class="form-control" id="singleSalePrice" name="singleSalePrice" min="0" step="0.01">
                                <div class="form-text">Enter the sale price, if applicable.</div>
                            </div>
                            <div class="field-group">
                                <label for="singleAvailable" class="form-label"><i class="bi bi-boxes"></i> Available Products</label>
                                <input type="number" class="form-control" id="singleAvailable" name="singleAvailable" min="0">
                                <div class="form-text">Enter the number of products in stock.</div>
                            </div>
                        </div>
                        <div id="singleHighlights" class="mt-3">
                            <label class="form-label"><i class="bi bi-star"></i> Highlights</label>
                            <div id="singleHighlightEntries"></div>
                            <button type="button" class="btn btn-sm btn-secondary" onclick="addHighlight('single')"><i class="bi bi-plus-circle"></i> Add Highlight</button>
                            <div class="form-text">Add key features or highlights of the product.</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Multiple Variation Fields -->
            <div id="multipleVariationFields" class="variation-section">
                <h5><i class="bi bi-boxes"></i> Multiple Variations</h5>
                <div id="variationEntries"></div>
                <button type="button" class="btn btn-sm btn-secondary" onclick="addVariation()"><i class="bi bi-plus-circle"></i> Add Variation</button>
                <div class="form-text">Add multiple variations with different sizes and/or colors.</div>
            </div>

            <!-- Images -->
            <div class="mb-3">
                <label for="productImages" class="form-label"><i class="bi bi-images"></i> Product Images</label>
                <div class="drop-zone" id="dropZone">
                    <i class="bi bi-upload"></i> Drag and drop images here or click to select
                    <input type="file" class="form-control d-none" id="productImages" name="productImages" multiple accept="image/*">
                </div>
                <div id="imagePreview" class="image-preview mt-2"></div>
                <div class="form-text">Upload multiple images to showcase the product.</div>
            </div>

            <!-- Poster Image -->
            <div class="mb-3">
                <label for="posterImage" class="form-label"><i class="bi bi-image"></i> Poster Image <span class="text-danger">*</span></label>
                <input type="file" class="form-control" id="posterImage" name="posterImage" accept="image/*" required>
                <div class="invalid-feedback">Please upload a poster image.</div>
                <div id="posterPreview" class="image-preview mt-2"></div>
                <div class="form-text">Upload the main poster image for the product.</div>
            </div>

            <button type="submit" class="btn btn-primary w-100"><i class="bi bi-check-circle"></i> Submit</button>
        </form>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
    // Initialize Select2 for searchable multiple select
    $(document).ready(() => {
        $('#events').select2({ placeholder: "Search events", allowClear: true, width: '100%' });
    });

    

    // Variation type toggle
    document.querySelectorAll('input[name="variationType"]').forEach(radio => {
        radio.addEventListener('change', function() {
            document.getElementById('singleVariationFields').style.display = this.value === 'single' ? 'block' : 'none';
            document.getElementById('multipleVariationFields').style.display = this.value === 'multiple' ? 'block' : 'none';
        });
    });

    // Add variation
    function addVariation() {
        const variationId = Date.now();
        const variationHtml = `
            <div class="variation-card card variation-entry" id="variation-${variationId}">
                <div class="card-header">
                    <span>Variation</span>
                    <i class="bi bi-x close-btn" onclick="document.getElementById('variation-${variationId}').remove()"></i>
                </div>
                <div class="card-body">
                    <div class="mb-2">
                        <label class="form-label"><i class="bi bi-sliders"></i> Variation Type</label>
                        <div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="variationType-${variationId}" value="size" checked onchange="toggleVariationFields(${variationId})">
                                <label class="form-check-label">Size</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="variationType-${variationId}" value="color" onchange="toggleVariationFields(${variationId})">
                                <label class="form-check-label">Color</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="variationType-${variationId}" value="both" onchange="toggleVariationFields(${variationId})">
                                <label class="form-check-label">Both</label>
                            </div>
                        </div>
                        <div class="form-text">Select the type of variation for this entry.</div>
                    </div>
                    <div class="inline-fields">
                        <div class="field-group size-field" id="sizeField-${variationId}">
                            <label class="form-label"><i class="bi bi-rulers"></i> Size</label>
                            <input type="text" class="form-control" name="size-${variationId}">
                            <div class="form-text">Enter the size (e.g., Small, Medium).</div>
                        </div>
                        <div class="field-group color-field" id="colorField-${variationId}" style="display: none;">
                            <label class="form-label"><i class="bi bi-palette"></i> Color</label>
                            <input type="text" class="form-control" name="color-${variationId}">
                            <div class="form-text">Enter the color (e.g., Red, Blue).</div>
                        </div>
                        <div class="field-group">
                            <label class="form-label"><i class="bi bi-currency-dollar"></i> Regular Price</label>
                            <input type="number" class="form-control" name="regularPrice-${variationId}" min="0" step="0.01">
                            <div class="form-text">Enter the regular price.</div>
                        </div>
                        <div class="field-group">
                            <label class="form-label"><i class="bi bi-tag-fill"></i> Sale Price</label>
                            <input type="number" class="form-control" name="salePrice-${variationId}" min="0" step="0.01">
                            <div class="form-text">Enter the sale price, if applicable.</div>
                        </div>
                        <div class="field-group">
                            <label class="form-label"><i class="bi bi-boxes"></i> Available Products</label>
                            <input type="number" class="form-control" name="available-${variationId}" min="0">
                            <div class="form-text">Enter the number of products in stock.</div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <label class="form-label"><i class="bi bi-star"></i> Highlights</label>
                        <div id="highlights-${variationId}"></div>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="addHighlight('multiple', ${variationId})"><i class="bi bi-plus-circle"></i> Add Highlight</button>
                        <div class="form-text">Add key features for this variation.</div>
                    </div>
                </div>
            </div>`;
        document.getElementById('variationEntries').insertAdjacentHTML('beforeend', variationHtml);
    }

    // Toggle size and color fields based on variation type
    function toggleVariationFields(variationId) {
        const variationType = document.querySelector(`input[name="variationType-${variationId}"]:checked`).value;
        const sizeField = document.getElementById(`sizeField-${variationId}`);
        const colorField = document.getElementById(`colorField-${variationId}`);
        sizeField.style.display = variationType === 'size' || variationType === 'both' ? 'block' : 'none';
        colorField.style.display = variationType === 'color' || variationType === 'both' ? 'block' : 'none';
    }

    // Add highlight
    function addHighlight(type, variationId = null) {
        const highlightId = Date.now();
        const containerId = type === 'single' ? 'singleHighlightEntries' : `highlights-${variationId}`;
        const namePrefix = type === 'single' ? 'single' : variationId;
        const highlightHtml = `
            <div class="highlight-entry mb-2" id="highlight-${highlightId}">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label"><i class="bi bi-bookmark"></i> Topic</label>
                        <input type="text" class="form-control" name="highlightTopic-${namePrefix}">
                        <div class="form-text">Enter the highlight topic.</div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label"><i class="bi bi-text-paragraph"></i> Description</label>
                        <textarea class="form-control" name="highlightDesc-${namePrefix}" rows="2"></textarea>
                        <div class="form-text">Describe the highlight.</div>
                    </div>
                </div>
                <button type="button" class="btn btn-sm btn-danger mt-2" onclick="document.getElementById('highlight-${highlightId}').remove()"><i class="bi bi-trash"></i> Remove Highlight</button>
            </div>`;
        document.getElementById(containerId).insertAdjacentHTML('beforeend', highlightHtml);
    }

    // Drag and drop for images
    const dropZone = document.getElementById('dropZone');
    const productImagesInput = document.getElementById('productImages');
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('dragover');
    });
    dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('dragover');
    });
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        const files = e.dataTransfer.files;
        productImagesInput.files = files;
        updateImagePreview(files);
    });
    dropZone.addEventListener('click', () => productImagesInput.click());
    productImagesInput.addEventListener('change', () => updateImagePreview(productImagesInput.files));

    function updateImagePreview(files) {
        const preview = document.getElementById('imagePreview');
        preview.innerHTML = '';

        // Create a DataTransfer to hold the files
        const dataTransfer = new DataTransfer();

        Array.from(files).forEach((file, index) => {
            const imgWrapper = document.createElement('div');
            imgWrapper.classList.add('image-thumb');
            imgWrapper.style.position = 'relative';
            imgWrapper.style.display = 'inline-block';
            imgWrapper.style.marginRight = '10px';

            const img = document.createElement('img');
            img.src = URL.createObjectURL(file);
            img.style.width = '100px';
            img.style.height = '100px';
            img.style.objectFit = 'cover';
            img.style.border = '1px solid #ddd';
            img.style.borderRadius = '4px';

            const removeBtn = document.createElement('span');
            removeBtn.innerHTML = '&times;';
            removeBtn.classList.add('remove-image-btn');
            removeBtn.style.position = 'absolute';
            removeBtn.style.top = '0';
            removeBtn.style.right = '5px';
            removeBtn.style.cursor = 'pointer';
            removeBtn.style.fontSize = '20px';
            removeBtn.style.color = 'red';
            removeBtn.title = 'Remove';

            // When clicked, remove image from preview and file list
            removeBtn.addEventListener('click', () => {
                imgWrapper.remove();
                const remainingFiles = Array.from(productImagesInput.files).filter((_, i) => i !== index);
                const newDataTransfer = new DataTransfer();
                remainingFiles.forEach(f => newDataTransfer.items.add(f));
                productImagesInput.files = newDataTransfer.files;
                updateImagePreview(productImagesInput.files);  // Refresh preview
            });

            imgWrapper.appendChild(img);
            imgWrapper.appendChild(removeBtn);
            preview.appendChild(imgWrapper);

            dataTransfer.items.add(file);  // Add file to DataTransfer
        });

        // Update the input’s file list
        productImagesInput.files = dataTransfer.files;
    }

    // Poster image preview
    document.getElementById('posterImage').addEventListener('change', function(event) {
        const preview = document.getElementById('posterPreview');
        preview.innerHTML = '';
        if (event.target.files[0]) {
            const img = document.createElement('img');
            img.src = URL.createObjectURL(event.target.files[0]);
            preview.appendChild(img);
        }
    });
</script>
{% endblock %}
