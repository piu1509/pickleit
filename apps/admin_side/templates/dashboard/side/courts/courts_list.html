{% extends "base.html" %}
{% load i18n %}
{% load static %}

{% block extra_css %}
<!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" crossorigin="anonymous"> -->
<!-- Custom CSS -->

{% endblock %}

{% block page_title %}
    Court
{% endblock %}

{% block content %}
<div class="page-breadcrumb">
    <form method="GET" action="">
        <div class="row d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center m-2">
                <h4 class="page-title">Court List</h4>
                <select class="form-control ml-3" name="page_length" style="width: 120px;" onchange="this.form.submit()">
                    <option value="20" {% if page_length == "20" %}selected{% endif %}>20</option>
                    <option value="50" {% if page_length == "50" %}selected{% endif %}>50</option>
                    <option value="100" {% if page_length == "100" %}selected{% endif %}>100</option>
                    <option value="200" {% if page_length == "200" %}selected{% endif %}>200</option>
                </select>
            </div>
            <div class="d-flex align-items-center">
                            
                <input type="text" id="location_input" name="location" class="form-control mx-2" placeholder="Search By Location..." style="width: 250px;" value="{{ request.GET.location }}"> 
                <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAfBo6-cZlOpKGrD1ZYwISIGjYvhH_wPmk&libraries=places"></script>
                <script>
                    function initialize() {
                        var input = document.getElementById('location_input');
                        var autocomplete = new google.maps.places.Autocomplete(input);
                    }

                    google.maps.event.addDomListener(window, 'load', initialize);
                </script>
                
                <input type="text" name="search_text" class="form-control mr-2" placeholder="Search Court..." 
                value="{% if search_text %}{{ search_text }}{% endif %}" style="width: 200px;">
            
                <button type="submit" class="btn btn-secondary"><i class="fas fa-search"></i></button>
                <a href="{% url 'dashboard:add_court' %}" class="btn btn-primary font-weight-bold ml-2">Add court</a>
            </div>
                   
        </div>
    </form>
</div>

<div class="container-fluid mb-5 mt-5 p-3">
    <div class="row mb-5">
        <div id="map" style="height: 400px; width: 100%; border-radius: 10px;"></div>
    </div>
    <div class="row mb-4">
        {% for court in courts %}   
            <div class="col-md-3 mb-4 d-flex">
                <a class="text-decoration-none text-dark" href="{% url 'dashboard:view_court' court.id%}">
                    <div class="card border w-100" style="display: flex; flex-direction: column; height: 100%;">
                        
                        <!-- Header -->
                        <div class="card-header text-center" style="font-weight: bold;">
                            {{ court.name }}
                        </div>
                        
                        <!-- Image Section -->
                        <div style="height: 200px; width: 100%; display: flex; align-items: center; justify-content: center; overflow: hidden; background: #f0f0f0;">
                            <img src="{% if court.image %}{{ court.image }}{% else %}https://pickleit.app/static/images/pickleit_newlogo.jpg{% endif %}" alt="{{ court.name }}" width="200" 
                                height="200" 
                                class="card-image">
                        </div>
                        
                        <!-- Body -->
                        <div class="card-body" style="flex-grow: 1; display: flex; flex-direction: column;">
                            <p style="margin-bottom: 5px;"><strong>Owner:</strong> {{ court.owner_name }}</p>
                            <p style="margin-bottom: 5px;"><strong>Location:</strong> {{ court.location }}</p>
                            <p class="card-text" style="flex-grow: 1; overflow: hidden; text-overflow: ellipsis; max-height: 50px;">{{ court.about }}</p>
                        </div>

                    </div>
                </a>
            </div>   

        {% empty %}
            <div class="d-flex justify-content-center align-items-center text-center w-100" style="height: 300px;">
    {% include 'dashboard/not_found.html' %}
</div>
        {% endfor %}
    </div>
    {% if courts.paginator.num_pages > 1 %}
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center">
                {% if courts.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1">First</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ courts.previous_page_number }}">Previous</a>
                    </li>
                {% endif %}

                {% for p in page_range %}
                    {% if p == "..." %}
                        <li class="page-item disabled"><span class="page-link">...</span></li>
                    {% else %}
                        <li class="page-item {% if courts.number == p %}active{% endif %}">
                            <a class="page-link" href="?page={{ p }}">{{ p }}</a>
                        </li>
                    {% endif %}
                {% endfor %}

                {% if courts.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ courts.next_page_number }}">Next</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ courts.paginator.num_pages }}">Last</a>
                    </li>
                {% endif %}
            </ul>
        </nav>  
    {% endif %}
</div>
<script>
    let map;
    let userLat = 40.7128, userLng = -74.0060; // Default location (New York)
    let courts = JSON.parse('{{ courts_json|safe }}'); // Use JSON-serialized data from Django

    function initMap() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(position => {
                userLat = position.coords.latitude;
                userLng = position.coords.longitude;
                initializeMap();
            }, () => {
                initializeMap();
            });
        } else {
            initializeMap();
        }
    }

    function initializeMap() {
        map = new google.maps.Map(document.getElementById("map"), {
            center: { lat: userLat, lng: userLng },
            zoom: 12
        });

        plotSystemcourts();
        fetchGooglecourts();
    }

    function plotSystemcourts() {
        courts.forEach(court => {
            const marker = new google.maps.Marker({
                position: { lat: parseFloat(court.latitude), lng: parseFloat(court.longitude) },
                map,
                title: court.name,
                icon: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png" // Blue for system courts
            });

            const infoWindow = new google.maps.InfoWindow({
                content: `<strong>${court.name}</strong><br>ðŸ“ ${court.location}`
            });

            marker.addListener("click", () => {
                infoWindow.open(map, marker);
            });
        });
    }

    function fetchGooglecourts() {
        fetch(`/user_side/fetch_pickleball_courts?lat=${userLat}&lng=${userLng}`)
            .then(response => response.json())
            .then(data => {
                data.pickleball_courts.forEach(court => {
                    const marker = new google.maps.Marker({
                        position: { lat: court.latitude, lng: court.longitude },
                        map,
                        title: court.name,
                        icon: "http://maps.google.com/mapfiles/ms/icons/red-dot.png" // Red for Google courts
                    });

                    const infoWindow = new google.maps.InfoWindow({
                        content: `<strong>${court.name}</strong>`
                    });

                    marker.addListener("click", () => {
                        infoWindow.open(map, marker);
                    });
                });
            });
    }

    function filtercourts() {
        let searchQuery = document.getElementById('searchBar').value.trim();
        if (event.key === "Enter") {
            window.location.href = `?q=${searchQuery}`;
        }
    }

    function filtercourtByLocation() {
        let locationQuery = document.getElementById('locationSearch').value.trim();
        if (event.key === "Enter") {
            window.location.href = `?location=${locationQuery}`;
        }
    }
</script>

<script async defer src="https://maps.googleapis.com/maps/api/js?key={{google_api_key}}&callback=initMap&libraries=places"></script>

{% endblock %}
 
